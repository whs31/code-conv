---
title: 1. Основные команды CMake
tags:
  - cmake
---
### Общая информация
**CMake** - это единственная и неповторимая система сборки, которую мы используем. **CMake** позволяет собрать C++ проект в исполняемый файл, статическую или динамическую библиотеку на разных платформах, компиляторах и операционных системах.

Каждый этап сборки с помощью CMake состоит из трёх шагов:
- **Конфигурация**: на этом этапе задаются переменные окружения, компиляторы, конфигурация сборки, шаблоны и прочее. Выполняет роль описание того, как будет собираться проект, но сам процесс компиляции и линковки происходит не здесь.
- **Сборка**: на этом этапе происходит компиляция и линковка всех целей CMake (*targets*) в соответствии с конфигурацией из предыдущего этапа.
- **Установка**: готовые бинарные файлы, заголовки и файлы конфигурации собираются в пакет и устанавливаются в указанную директорию (*префиксный путь*). Это опциональный этап, но хорошим тоном является описывать шаг установки в своих CMake-файлах.

### Конфигурация
Для конфигурации проекта необходимо вызвать команду `cmake` со следующими аргументами:
- `-S` - папка, в которой лежит корневой *CMakeLists.txt* вашего проекта
- `-B` - папка, в которой вы хотите произвести сборку
- `-G [Ninja|...]` - генератор (подробнее про генераторы [здесь](https://stackoverflow.com/questions/25941536/what-is-a-cmake-generator)). Мы используем `Ninja` в качестве основного генератора.
- `-DCMAKE_BUILD_TYPE=[Release|Debug|MinSizeRel|RelWithDebugInfo]` - шаблон сборки. Для релизных проектов всегда выбирайте `Release`, для разработки - `Debug`.
- `-DBUILD_SHARED_LIBS=[ON|OFF]` - выбор между статической/динамической версией сборки (только для библиотек). Для сборки динамической библиотеки используйте `ON`, в противном случае - `OFF`
- `-DCMAKE_C_COMPILER=$PATH` - выбор компилятора для языка `C`. По умолчанию для генератора `Ninja` на ОС Linux это `gcc`, на ОС Windows - `mingw-w64-x86_64-gcc` (если установлен) или `cl.exe` (MSVC). Не указывайте этот аргумент в большинстве случаев.
- `-DCMAKE_CXX_COMPILER` - аналогично предыдущему, выбор компилятора для языка `C++`. По умолчанию для генератора `Ninja` на ОС Linux это `g++`, на ОС Windows - `mingw-w64-x86_64-g++` или `cl.exe`.
- `--preset` и `-DCMAKE_TOOLCHAIN_PATH` - подробнее об этом в статье про **Conan**. (здесь появится ссылка, когда я ее напишу!).

##### Примеры конфигурации проекта, лежащего в текущей рабочей директории:
###### Простая отладочная конфигурация
```shell
cmake -S . -B target/debug -G Ninja
```

###### Конфигурация динамической библиотеки 
```shell
cmake -S . -B target/release -G Ninja\
-DCMAKE_BUILD_TYPE="Release"\
-DBUILD_SHARED_LIBS=ON
```

###### Конфигурация релизной динамической библиотеки с помощью Clang
```shell
cmake -S . -B target/release-clang -G Ninja\
-DCMAKE_BUILD_TYPE="Release"\
-DBUILD_SHARED_LIBS=ON\
-DCMAKE_C_COMPILER="/usr/bin/clang"\
-DCMAKE_CXX_COMPLILER="/usr/bin/clang++"
```

###### Конфигурация для кросс-компиляции под Windows из ОС Linux
```shell
x86_64-w64-mingw32-cmake -S . -B target/release -G Ninja\
-DCMAKE_BUILD_TYPE="Release"\
-DBUILD_SHARED_LIBS=ON
```

> [!info] Примечание
> Обратите внимание, что для кросс-компиляции под Windows на этапе конфигурации используется команда `x86_64-w64-mingw32-cmake` вместо `cmake`. Это необходимо для корректного выбора компилятора и настройки среды MinGW, 
> Данная команда применяется **только к этапу конфигурации**. Дальнейшая сборка и установка будет выполняться обычной командой `cmake`.
